WITH vd_tokens AS (
  SELECT
    UPPER(BRAND) AS VENDOR,
    ARRAY_AGG(DISTINCT VALUE) AS TOKENS
  FROM VENDOR_DIRECTORY,
       LATERAL SPLIT_TO_TABLE(UPPER(BRAND), ' ')
  GROUP BY 1
),
tx_tokens AS (
  SELECT
    DAF_MERCH_NAME,
    DAF_MERCH_CITY,
    ARRAY_AGG(DISTINCT VALUE) AS TOKENS
  FROM TRANSACTIONS,
       LATERAL SPLIT_TO_TABLE(UPPER(DAF_MERCH_NAME), ' ')
  WHERE UPPER(DAF_MERCH_CITY) LIKE '%TYSON%'
  GROUP BY 1,2
),
pairs AS (
  SELECT
    v.VENDOR, t.DAF_MERCH_NAME, t.DAF_MERCH_CITY, v.TOKENS AS V_TOK, t.TOKENS AS T_TOK
  FROM vd_tokens v
  JOIN tx_tokens t ON TRUE
),
intersections AS (
  SELECT
    p.VENDOR, p.DAF_MERCH_NAME, p.DAF_MERCH_CITY,
    COUNT(DISTINCT vt.VALUE) AS inter_cnt
  FROM pairs p,
       LATERAL FLATTEN(INPUT => p.V_TOK) vt,
       LATERAL FLATTEN(INPUT => p.T_TOK) tt
  WHERE vt.VALUE = tt.VALUE
  GROUP BY 1,2,3
),
sizes AS (
  SELECT
    p.VENDOR, p.DAF_MERCH_NAME, p.DAF_MERCH_CITY,
    (SELECT COUNT(DISTINCT VALUE) FROM LATERAL FLATTEN(INPUT => p.V_TOK)) AS v_size,
    (SELECT COUNT(DISTINCT VALUE) FROM LATERAL FLATTEN(INPUT => p.T_TOK)) AS t_size
  FROM pairs p
)
SELECT
  s.VENDOR,
  s.DAF_MERCH_NAME AS MATCHED_MERCHANT,
  s.DAF_MERCH_CITY AS MATCHED_CITY,
  i.inter_cnt,
  (s.v_size + s.t_size - i.inter_cnt) AS union_cnt,
  (i.inter_cnt * 1.0) / NULLIF(s.v_size + s.t_size - i.inter_cnt, 0) AS jaccard
FROM sizes s
LEFT JOIN intersections i
  ON s.VENDOR = i.VENDOR AND s.DAF_MERCH_NAME = i.DAF_MERCH_NAME
QUALIFY ROW_NUMBER() OVER (PARTITION BY s.VENDOR ORDER BY jaccard DESC) = 1
-- WHERE jaccard >= 0.55
ORDER BY jaccard DESC;
